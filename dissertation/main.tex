%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Overleaf (WriteLaTeX) Example: Molecular Chemistry Presentation
%
% Source: http://www.overleaf.com
%
% In these slides we show how Overleaf can be used with standard 
% chemistry packages to easily create professional presentations.
% 
% Feel free to distribute this example, but please keep the referral
% to overleaf.com
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% How to use Overleaf: 
%
% You edit the source code here on the left, and the preview on the
% right shows you the result within a few seconds.
%
% Bookmark this page and share the URL with your co-authors. They can
% edit at the same time!
%
% You can upload figures, bibliographies, custom classes and
% styles using the files menu.
%
% If you're new to LaTeX, the wikibook is a great place to start:
% http://en.wikibooks.org/wiki/LaTeX
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[hyperref={colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}]{beamer}

% For more themes, color themes and font themes, see:
% http://deic.uab.es/~iblanes/beamer_gallery/index_by_theme.html
%
\mode<presentation>
{
  \usetheme{Madrid}       % or try default, Darmstadt, Warsaw, ...
  \usecolortheme{default} % or try albatross, beaver, crane, ...
  \usefonttheme{serif}    % or try default, structurebold, ...
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
} 

\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{chemfig}
\usepackage[version=3]{mhchem}
\usepackage{tikz}
\usetikzlibrary{plotmarks}
\usepackage{pgfplots}
\usepackage{lineno}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{subcaption}
\usepackage{pgf}  
\usepackage{svg}
\usepackage{ragged2e}
\usepackage{booktabs}
\usepackage{float}

\newlength\figureheight
\newlength\figurewidth
% \addtobeamertemplate{navigation symbols}{}{%
%     \usebeamerfont{footline}%
%     \usebeamercolor[fg]{footline}%
%     \hspace{5em}%
%     \insertframenumber/\inserttotalframenumber
% }

\setbeamertemplate{navigation symbols}{}
% \setbeamertemplate{footline}[frame number]{}
\setbeamertemplate{page number in head/foot}[totalframenumber]

% On Overleaf, these lines give you sharper preview images.
% You might want to `comment them out before you export, though.
\usepackage{pgfpages}
\pgfpagesuselayout{resize to}[%
  physical paper width=8in, physical paper height=6in]

% Here's where the presentation starts, with the info for the title slide
\title[]{Optimization and Prediction in Natural Gas Networks Using Graph Neural Networks and MPCC-Based Models}
\author{Cristian Alejandro Blanco Martínez}
\institute{Universidad Tecnológica de Pereira \\ 
Grupo de investigación Automática}
\date{\today}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}




\begin{frame}{Energy Context \& Relevance of Natural Gas}
\justifying
Natural gas plays a crucial role in the global energy mix, offering a cleaner alternative to other fossil fuels by producing lower CO\textsubscript{2} emissions. It supports both industrial processes and electricity generation, acting as a reliable energy source in diverse contexts. 
\\ \\
In Colombia, natural gas is widely used across the residential, commercial, industrial, and thermal power sectors. Its importance becomes evident during dry seasons, when hydroelectric generation is reduced and thermal plants, fueled by natural gas, step in to maintain electricity supply.
\end{frame}

\begin{frame}{Operational Challenge in the Colombian Energy System}
\justifying
Colombia’s electricity supply relies heavily on hydroelectric plants, which are highly dependent on rainfall patterns. During dry seasons, reduced water availability forces the system to increase the participation of thermal plants powered by natural gas. 

This seasonal shift places significant operational stress on the gas transport network. 
% \begin{itemize}
%     \item More frequent re-optimizations of gas flows.
%     \item Rapid and accurate decision-making to ensure supply security.
% \end{itemize}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.65\textwidth]{figures/hydro_vs_thermal.png}
    \caption{Variation in electricity generation mix between wet and dry seasons in Colombia.}
\end{figure}
\end{frame}


% These three lines create an automatically generated table of contents.
\begin{frame}{Motivation \& Problem Statement}
\justifying
\begin{itemize}
    \item \textbf{Large-scale natural gas networks} require solving complex optimization problems.
    \item Classical approaches are accurate but often \textbf{computationally expensive}.
    \item Increasing network size and operational constraints lead to:
    \begin{itemize}
        \item Long execution times
        \item Difficulty in real-time or near real-time decision making
    \end{itemize}
    \item Need for approaches that \textbf{preserve accuracy while reducing computation time}.
\end{itemize}
\end{frame}


\begin{frame}{Objectives}
\textbf{General Objective:}
\begin{itemize}
    \item Develop an optimization tool that integrates knowledge of the gas transportation network topology, a suitable approximation of the Weymouth equation and stochastic optimization techniques to address the gas transportation task taking into account the uncertainties related to hydroelectric generation and the growth of alternative energy sources.
\end{itemize}
\end{frame}

\begin{frame}{Objectives}
\textbf{Specific Objectives:}
\begin{itemize}
    \item Design a Graph Neural Networks-based approach of regression that integrates knowledge of natural gas network topology to reduce computational time for operation estimation.    
    \item Develop an optimization model for natural gas transportation systems that takes into account the Weymouth equation for reducing that reduces the approximation error in pipeline gas flow calculations.
    \item Develop a stochastic gas flow dispatch optimization strategy that quantifies the uncertainty in the objective variables and decision variables associated with the operation of the gas system taking into account the constraints of the transportation problem.
\end{itemize}
\end{frame}



%===========================================
% Chapter 2 — GNN Surrogate (CensNet) Overview
%===========================================
\section{Natural Gas System Prediction Using Graph Neural Networks}

%-------------------------------------------
% Slide 1: Motivation & Concept
%-------------------------------------------
\begin{frame}{Natural Gas System Prediction Using Graph Neural Networks}
    \begin{itemize}
        \item Traditional optimizers are \textbf{accurate but slow} for large-scale or real-time scenarios.
        \item Gas networks are inherently \textbf{graphs}: nodes = wells, users, storage; edges = pipelines, compressors.
        \item GNNs exploit \textbf{topology-aware learning} for faster prediction.
        \item \textbf{Goal:} Achieve near-optimizer accuracy with runtime reduction.
    \end{itemize} 
\end{frame}

%-------------------------------------------
% Slide: CensNet Architecture
%-------------------------------------------

\begin{frame}{CensNet Layers: Integrating Node \& Edge Features}
\footnotesize
\textbf{Motivation:}  
Traditional GCNs focus mainly on \textit{node features} and ignore \textit{edge features}, missing part of the graph’s information.

\medskip
\textbf{CensNet innovation:}
\begin{itemize}
    \item Alternates between \textbf{node layers} and \textbf{edge layers}.
    \item Each layer type updates its own features while using information from the other:
    \begin{itemize}
        \item \textbf{Node layer:} Node embeddings are updated using both node adjacency and transformed edge features.
        \item \textbf{Edge layer:} Edge embeddings are updated using edge adjacency and transformed node features.
    \end{itemize}
    \item Uses an \textit{incidence matrix} \( \mathbf{T} \) to switch between node and edge domains.
\end{itemize}

\medskip
\textbf{Benefits:}
\begin{itemize}
    \item Captures both \textit{structural} (adjacency) and \textit{relational} (edge) information.
    \item Enhances long-range dependencies through alternating propagation.
\end{itemize}
\end{frame}

\begin{frame}{Mathematical Structure of CensNet Layers}
\footnotesize
\textbf{Node layer propagation:}
\[
\mathbf{H}^{(l+1)}_v = \sigma\left(
\mathbf{T} \Phi(\mathbf{H}^{(l)}_e \mathbf{p}_e) \mathbf{T}^\top 
\odot \tilde{\mathbf{A}}_v \mathbf{H}^{(l)}_v \mathbf{W}_v
\right)
\]
\textbf{Edge layer propagation:}
\[
\mathbf{H}^{(l+1)}_e = \sigma\left(
\mathbf{T}^\top \Phi(\mathbf{H}^{(l)}_v \mathbf{p}_v) \mathbf{T} 
\odot \tilde{\mathbf{A}}_e \mathbf{H}^{(l)}_e \mathbf{W}_e
\right)
\]

\medskip
\textbf{Key components:}
\begin{itemize}
    \item \( \tilde{\mathbf{A}}_v, \tilde{\mathbf{A}}_e \): normalized adjacency matrices (nodes/edges).
    \item \( \mathbf{T} \): incidence matrix mapping between node and edge domains.
    \item \( \Phi(\cdot) \): diagonal scaling from projected features.
    \item \( \odot \): element-wise filtering of adjacency by feature-derived weights.
\end{itemize}

\medskip
\textbf{Core idea:} Information “switches” between node and edge spaces at each step, enriching representations.
\end{frame}

\begin{frame}{CensNet-based Model Architecture}
\footnotesize
\justifying
    \centering
    \resizebox{0.9\textwidth}{!}{%
        \input{figures/model_description.tex}%
    } 

\textbf{Inputs:} Encapsulate both physical attributes and topological information of the gas network:
        \begin{itemize}
            \item Node features ($\mathbf{X}$): pressures, injections, withdrawals, demand forecasts.
            \item Node Laplacian ($\mathbf{L}_v$) and Edge Laplacian ($\mathbf{L}_e$): encode structural connectivity and enable topology-aware learning.
            \item Edge features ($\mathbf{E}$): capacities, compressor ratios.
            \item Incidence matrix ($\mathbf{T}$): explicit mapping between nodes and edges.
        \end{itemize} 
\end{frame}


\begin{frame}{CensNet-based Model Architecture}   
\footnotesize
    \begin{itemize} 
        \item \textbf{Processing:}
        \begin{itemize}
            \item Normalization and pre-dense layers transform inputs into a common latent space.
            \item \emph{CensNet convolutional blocks} perform message passing on both node and edge domains, enabling simultaneous learning of flow patterns and interactions.
            \item Post-dense layers refine features for prediction.
        \end{itemize}
        
        \item \textbf{Outputs:}
        \begin{itemize}
            \item Node-level injected flows ($\hat{\mathbf{X}}_v$) — predicted gas supply/demand at each node.
            \item Edge-level transported flows ($\hat{\mathbf{X}}_e$) — predicted flow rates in each pipeline.
        \end{itemize}
        
   \end{itemize}
\end{frame}


\begin{frame}{CensNet-based Model Architecture}   
\footnotesize
    \begin{itemize} 
       \item \textbf{Training:} Node and edge predictions are penalized separately using task-specific loss terms, ensuring both accuracy and physical consistency. 
        For regression tasks, the model minimizes a regularized MSE loss:
        \[
            \mathcal{L}(\Theta) = \sum_{r=1}^{R} \| Y_r - \hat{Y}_r \|^2_2 + \lambda \|\Theta\|_p
        \]
        where $Y_r$ and $\hat{Y}_r$ are target and predicted values for task $r$, and $\lambda\|\Theta\|_p$ is a regularization term to prevent overfitting.
    \end{itemize}
\end{frame}



\begin{frame}{Optimization Problem: Objective and Constraints}
\footnotesize
The gas network consists of wells $\mathcal{W}$ (supply nodes), users $\mathcal{U}$ (demand nodes), pipelines $\mathcal{P}$, and compressors $\mathcal{C}$.

\[
\min_{\mathcal{P}, \mathcal{F}} 
\sum_{t \in \mathcal{T}} \left(
\sum_{w \in \mathcal{W}} C_{w} f_{w} +
\sum_{p \in \mathcal{P}} C_{p} f_{p} +
\sum_{c \in \mathcal{C}} C_{c} f_{c} +
\sum_{u \in \mathcal{U}} C_{u} f_{u}
\right)
\]
where $C_i$ is the cost per unit flow at element $i$, and $f_i$ is the corresponding gas flow.

\begin{align}
    \underline{f_{w}} \leq f_{w} \leq \overline{f_{w}} 
    &\quad \forall \ w \in \mathcal{W} 
    &&\parbox{3cm}{\centering Well capacity} \label{eq:well_limits} \\
    -\overline{f_{p}} \leq f_{p} \leq \overline{f_{p}} 
    &\quad \forall \ p \in \mathcal{P} 
    &&\parbox{3cm}{\centering Pipeline limits} \label{eq:pipe_limits} \\
    0 \leq f_{u} \leq \overline{f_{u}} 
    &\quad \forall \ u \in \mathcal{U} 
    &&\parbox{3cm}{\centering Demand satisfaction} \label{eq:dem_limit_gas} \\
    \sum_{m:(m,n)\in\mathcal{A}} f_{m} 
    &= \sum_{m':(n,m')\in\mathcal{A}} f_{m'} 
    &&\parbox{3cm}{\centering Nodal gas balance} \label{eq:gas_balance}
\end{align}
\end{frame}


\begin{frame}{Dataset}
\footnotesize
Two different gas network configurations were used to evaluate the proposed CensNet-based model. 
The first is a small synthetic case for controlled experimentation, while the second corresponds 
to the real Colombian natural gas transportation system.

\begin{table}[H]
    \centering
    \begin{tabular}{lcccc}
        \toprule
        \textbf{Case} & \textbf{Nodes} & \textbf{Pipelines} & \textbf{Compressors} & \textbf{Users} \\
        \midrule
        Small Network & 8  & 6  & 2  & 2  \\
        Colombian Network & 63 & 48 & 14 & 27 \\
        \bottomrule
    \end{tabular}
    \caption{Characteristics of the datasets used.}
\end{table}
\end{frame}
%


\begin{frame}{Experimental Setup}
\footnotesize
Different network operation scenarios were generated by adding 5\%--25\% noise to user demand values 
and solving each scenario with the linear constrained optimization model using APOPT (via GEKKO). 
The outputs served as ground truth for CensNet model training.

\begin{itemize}
    \item \textbf{Data split:} 60\% training, 20\% validation, 20\% testing.
    \item \textbf{Samples:} 2000 (8-node network), 2400 (63-node network).
    \item \textbf{Training:} 1500 epochs, Adam optimizer, Leaky ReLU activation ($\alpha = 0.2$).
    \item \textbf{Learning rate:} Initial $1\times 10^{-2}$, exponential decay (rate 0.9, steps 1000).
    \item \textbf{Hyperparameters:} 
        \begin{itemize}
            \item $N_{\text{channels}}$: 16–64
            \item $N_{\text{layers}}$: 1–5 (CensNet convolutional)
            \item $N_{\text{dense}}$: 2–32 (post-dense layers)
        \end{itemize}
    \item \textbf{Losses tested:} 
        \begin{itemize}
            \item Nodal loss only
            \item Nodal + Edge loss
        \end{itemize}
\end{itemize}
\end{frame}
%
%

\begin{frame}{Main Results: Prediction Accuracy}
\footnotesize
\textbf{Networks:} 8-node (synthetic) and 63-node (Colombian gas system)  
\\
\textbf{Models:} CensNet (N) – nodal loss only, CensNet (N+E) – nodal + edge loss

\begin{itemize}
    \item \textbf{Nodal flow predictions:} High $R^2$ in both settings
        \begin{itemize}
            \item 8-node: $R^2$ = 0.988 (N), 0.988 (N+E)
            \item 63-node: $R^2$ = 0.996 (N), 0.996 (N+E)
        \end{itemize}
    \item \textbf{Edge flow predictions:} 
        \begin{itemize}
            \item (N) performs poorly on edges: $R^2$ low
            \item (N+E) improves dramatically: $R^2$ up to 0.999 (8-node) and 0.996 (63-node)
        \end{itemize}
    \item \textbf{Key takeaway:} Including edge loss is essential for accurate pipeline/compressor flow prediction.
\end{itemize}

% \centering
% \includegraphics[width=0.45\textwidth]{figures/Chapter_LinealCensnet/ye_dummy_base_f.pdf}
% \includegraphics[width=0.45\textwidth]{figures/Chapter_LinealCensnet/ye_col_base_f.pdf}
\end{frame}



\begin{frame}{Main Results: Gas Balance \& Speed}
\footnotesize
\textbf{Gas balance consistency (APOPT – CensNet differences):}
\begin{itemize}
    \item \textbf{8-node:} Edge error reduced from 62.92 (N) $\rightarrow$ 39.24 (N+E)
    \item \textbf{63-node:} Edge error reduced from 62.47 (N) $\rightarrow$ -0.07 (N+E)
    \item Nodal differences $< 0.1$ units in all cases
\end{itemize}

\textbf{Prediction speed:}  
T-tests confirm \textbf{CensNet is significantly faster} than APOPT
\begin{itemize}
    \item 8-node: $T=14.94$, $p=1.32\times10^{-34}$
    \item 63-node: $T=47.29$, $p=4.92\times10^{-110}$
\end{itemize}

\textbf{Summary:}  
\begin{itemize}
    \item Comparable accuracy to optimization model
    \item Better edge prediction with (N+E)
    \item Substantial speed advantage
\end{itemize}
\end{frame}

%

\end{document}
