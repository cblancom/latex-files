%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Overleaf (WriteLaTeX) Example: Molecular Chemistry Presentation
%
% Source: http://www.overleaf.com
%
% In these slides we show how Overleaf can be used with standard 
% chemistry packages to easily create professional presentations.
% 
% Feel free to distribute this example, but please keep the referral
% to overleaf.com
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% How to use Overleaf: 
%
% You edit the source code here on the left, and the preview on the
% right shows you the result within a few seconds.
%
% Bookmark this page and share the URL with your co-authors. They can
% edit at the same time!
%
% You can upload figures, bibliographies, custom classes and
% styles using the files menu.
%
% If you're new to LaTeX, the wikibook is a great place to start:
% http://en.wikibooks.org/wiki/LaTeX
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[hyperref={colorlinks,citecolor=blue,linkcolor=blue,urlcolor=blue}]{beamer}

% For more themes, color themes and font themes, see:
% http://deic.uab.es/~iblanes/beamer_gallery/index_by_theme.html
%
\mode<presentation>
{
  \usetheme{Madrid}       % or try default, Darmstadt, Warsaw, ...
  \usecolortheme{default} % or try albatross, beaver, crane, ...
  \usefonttheme{serif}    % or try default, structurebold, ...
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
} 

\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{chemfig}
\usepackage[version=3]{mhchem}
\usepackage{tikz}
\usetikzlibrary{plotmarks}
\usepackage{pgfplots}
\usepackage{lineno}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{subcaption}
\usepackage{pgf}  
\usepackage{svg}
\usepackage{ragged2e}
\usepackage{booktabs}
\usepackage{float}
\usepackage{caption}
% \usetikzlibrary{external}
% \tikzexternalize[prefix=figures/generated/]
\newlength\figureheight
\newlength\figurewidth
% \addtobeamertemplate{navigation symbols}{}{%
%     \usebeamerfont{footline}%
%     \usebeamercolor[fg]{footline}%
%     \hspace{5em}%
%     \insertframenumber/\inserttotalframenumber
% }

\setbeamertemplate{navigation symbols}{}
% \setbeamertemplate{footline}[frame number]{}
\setbeamertemplate{page number in head/foot}[totalframenumber]

% On Overleaf, these lines give you sharper preview images.
% You might want to `comment them out before you export, though.
\usepackage{pgfpages}
\pgfpagesuselayout{resize to}[%
  physical paper width=8in, physical paper height=6in]

% Here's where the presentation starts, with the info for the title slide
\title[]{Optimization and Prediction in Natural Gas Networks Using Graph Neural Networks and MPCC-Based Models}
\author{Cristian Alejandro Blanco Martínez}
\institute{Universidad Tecnológica de Pereira \\ 
Grupo de investigación Automática}
\date{\today}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}




\begin{frame}{Energy Context \& Relevance of Natural Gas}
\footnotesize
\justifying
% Natural gas plays a crucial role in the global energy mix, offering a cleaner alternative to other fossil fuels by producing lower CO\textsubscript{2} emissions. It supports both industrial processes and electricity generation, acting as a reliable energy source in diverse contexts. 
In Colombia, natural gas is widely used across the residential, commercial, industrial, and thermal power sectors. Its importance becomes evident during dry seasons, when hydroelectric generation is reduced and thermal plants, fueled by natural gas, step in to maintain electricity supply  \cite{Promigas_2021}.
\\
\begin{figure}[h]
    \centering
    \footnotesize
    \includegraphics[width=0.6\textwidth]{figures/hydro_vs_thermal.png}
    \caption{\footnotesize Variation in electricity generation mix between wet and dry seasons in Colombia.}
\end{figure}
\end{frame}

% \begin{frame}{Operational Challenge in the Colombian Energy System}
% \justifying
% Colombia’s electricity supply relies heavily on hydroelectric plants, which are highly dependent on rainfall patterns. During dry seasons, reduced water availability forces the system to increase the participation of thermal plants powered by natural gas. 
%
% This seasonal shift places significant operational stress on the gas transport network. 
% % \begin{itemize}
% %     \item More frequent re-optimizations of gas flows.
% %     \item Rapid and accurate decision-making to ensure supply security.
% % \end{itemize}
%
% \begin{figure}[h]
%     \centering
%     \includegraphics[width=0.65\textwidth]{figures/hydro_vs_thermal.png}
%     \caption{Variation in electricity generation mix between wet and dry seasons in Colombia.}
% \end{figure}
% \end{frame}
%
%


\begin{frame}{Motivation \& Problem Statement}
\footnotesize
\justifying
\begin{itemize}
    \item \textbf{Large-scale natural gas networks} require solving complex optimization problems.
    \item Increasing network size and operational constraints lead to:
    \begin{itemize}
        \item Long execution times
        \item Difficulty in real-time or near real-time decision making
    \end{itemize}
    \item Classical approaches are accurate but often \textbf{computationally expensive}.
\end{itemize}

\vspace{0.5cm}
\textbf{Main Problem:} There is a need for methods that preserve accuracy while significantly reducing computation time.

\vspace{0.5cm}
\textbf{Research Question:} How can an optimization tool be developed that seeks to improve the solution to the problem of natural gas transportation, taking into account computational cost, growing energy demand, and the uncertainty associated with this factor?
\end{frame}


\begin{frame}{Objectives}
\footnotesize
\textbf{General Objective:}
\begin{itemize}
    \item Develop an optimization tool that integrates knowledge of the gas transportation network topology, a suitable approximation of the Weymouth equation and stochastic optimization techniques to address the gas transportation task taking into account the uncertainties related to hydroelectric generation and the growth of alternative energy sources.
\end{itemize}
\textbf{Specific Objectives:}
\begin{itemize}
    \item Design a Graph Neural Networks-based approach of regression that integrates knowledge of natural gas network topology to reduce computational time for operation estimation.    
    \item Develop an optimization model for natural gas transportation systems that takes into account the Weymouth equation for reducing that reduces the approximation error in pipeline gas flow calculations.
    \item Develop a stochastic gas flow dispatch optimization strategy that quantifies the uncertainty in the objective variables and decision variables associated with the operation of the gas system taking into account the constraints of the transportation problem.
\end{itemize}
\end{frame}

% \begin{frame}{Objectives}
% \textbf{Specific Objectives:}
% \begin{itemize}
%     \item Design a Graph Neural Networks-based approach of regression that integrates knowledge of natural gas network topology to reduce computational time for operation estimation.    
%     \item Develop an optimization model for natural gas transportation systems that takes into account the Weymouth equation for reducing that reduces the approximation error in pipeline gas flow calculations.
%     \item Develop a stochastic gas flow dispatch optimization strategy that quantifies the uncertainty in the objective variables and decision variables associated with the operation of the gas system taking into account the constraints of the transportation problem.
% \end{itemize}
% \end{frame}
%
%

%===========================================
% Chapter 2 — GNN Surrogate (CensNet) Overview
%===========================================
\section{Natural Gas System Prediction Using Graph Neural Networks}

%-------------------------------------------
% Slide 1: Motivation & Concept
%-------------------------------------------

\begin{frame}{Natural Gas System as a Graph}
    \footnotesize
    \justifying
    A natural gas network can be represented as a directed graph, 
    where nodes correspond to elements such as wells, users, or storage facilities, 
    and edges represent pipelines and compressors.
    \begin{figure}
    \begin{center}
        \includegraphics[width=0.7\linewidth]{figures/8_node_system.png}
        \caption{\footnotesize Example of an 8-node gas network represented.}
    \end{center}
    \end{figure}

    \vspace{0.3cm}
    \textbf{Objective:} Achieve near-optimizer accuracy with significant runtime reduction.
\end{frame}

%-------------------------------------------
% Slide: CensNet Architecture
%-------------------------------------------

\begin{frame}{CensNet Layers: Integrating Node \& Edge Features}
\footnotesize
\textbf{Motivation:}  
Traditional GCNs focus mainly on \textit{node features} and ignore \textit{edge features}, missing part of the graph’s information.

\medskip
\textbf{CensNet innovation:}
\begin{itemize}
    \item Alternates between \textbf{node layers} and \textbf{edge layers}.
    \item Each layer type updates its own features while using information from the other:
    \begin{itemize}
        \item \footnotesize \textbf{Node layer:} Node embeddings are updated using both node adjacency and transformed edge features.
        \item \footnotesize \textbf{Edge layer:} Edge embeddings are updated using edge adjacency and transformed node features.
    \end{itemize}
    \item Uses an \textit{incidence matrix} \( \mathbf{T} \) to switch between node and edge domains.
\end{itemize}

\medskip
\textbf{Benefits:}
\begin{itemize}
    \item Captures both \textit{structural} (adjacency) and \textit{relational} (edge) information.
    \item Enhances long-range dependencies through alternating propagation.
\end{itemize}
\end{frame}


\begin{frame}{Mathematical Structure of CensNet Layers}
\footnotesize
\textbf{Node layer propagation:}
\[
\mathbf{H}^{(l+1)}_v = \sigma\left(
\mathbf{T} \Phi(\mathbf{H}^{(l)}_e \mathbf{p}_e) \mathbf{T}^\top 
\odot \tilde{\mathbf{A}}_v \mathbf{H}^{(l)}_v \mathbf{W}_v
\right)
\]
\textbf{Edge layer propagation:}
\[
\mathbf{H}^{(l+1)}_e = \sigma\left(
\mathbf{T}^\top \Phi(\mathbf{H}^{(l)}_v \mathbf{p}_v) \mathbf{T} 
\odot \tilde{\mathbf{A}}_e \mathbf{H}^{(l)}_e \mathbf{W}_e
\right)
\]

\medskip
\textbf{Key components:}
\begin{itemize}
    \item \( \tilde{\mathbf{A}}_v, \tilde{\mathbf{A}}_e \): normalized adjacency matrices (nodes/edges).
    \item \( \mathbf{T} \): incidence matrix mapping between node and edge domains.
    \item \( \Phi(\cdot) \): diagonal scaling from projected features.
    \item \( \odot \): element-wise filtering of adjacency by feature-derived weights.
\end{itemize}

\medskip
\textbf{Core idea:} Information “switches” between node and edge spaces at each step, enriching representations.
\end{frame}

\begin{frame}{CensNet-based Model Architecture}
\footnotesize
\justifying
    \centering
    \resizebox{0.9\textwidth}{!}{%
        \input{figures/model_description.tex}%
    } 

\textbf{Inputs:} Encapsulate both physical attributes and topological information of the gas network:
        \begin{itemize}
            \item \footnotesize Node features ($\mathbf{X}$): pressures, injections, withdrawals, demand forecasts.
            \item \footnotesize Node Laplacian ($\mathbf{L}_v$) and Edge Laplacian ($\mathbf{L}_e$): encode structural connectivity and enable topology-aware learning.
            \item \footnotesize Edge features ($\mathbf{E}$): capacities, compressor ratios.
            \item \footnotesize Incidence matrix ($\mathbf{T}$): explicit mapping between nodes and edges.
        \end{itemize} 
\end{frame}


\begin{frame}{CensNet-based Model Architecture}   
\footnotesize
    \begin{itemize} 
        \item \textbf{Processing:}
        \begin{itemize}
            \item \footnotesize Normalization and pre-dense layers transform inputs into a latent space.
            \item \footnotesize CensNet blocks perform message passing on both node and edge domains, enabling simultaneous learning of flow patterns and interactions.
            \item \footnotesize Post-dense layers refine features for prediction.
        \end{itemize}
        
        \item \textbf{Outputs:}
        \begin{itemize}
            \item \footnotesize Node-level flows ($\hat{\mathbf{X}}_v$) — predicted gas supply/demand at each node.
            \item \footnotesize Edge-level transported flows ($\hat{\mathbf{X}}_e$) — predicted flow rates in each pipeline.
        \end{itemize}        
   \end{itemize}

    \begin{itemize} 
       \item \footnotesize \textbf{Training:} Node and edge predictions are penalized separately using task-specific loss terms, ensuring both accuracy and physical consistency.  
        \[
            \mathcal{L}(\Theta) = \sum_{r=1}^{R} \| Y_r - \hat{Y}_r \|^2_2 + \lambda \|\Theta\|_p
        \]
        where $Y_r$ and $\hat{Y}_r$ are target and predicted values for task $r$, and $\lambda\|\Theta\|_p$ is a regularization term to prevent overfitting.
    \end{itemize}
\end{frame}


\begin{frame}{Optimization Problem: Objective and Constraints}
\footnotesize
The gas network consists of wells $\mathcal{W}$ (supply nodes), users $\mathcal{U}$ (demand nodes), pipelines $\mathcal{P}$, and compressors $\mathcal{C}$.

\[
\min_{\mathcal{P}, \mathcal{F}} 
\sum_{t \in \mathcal{T}} \left(
\sum_{w \in \mathcal{W}} C_{w} f_{w} +
\sum_{p \in \mathcal{P}} C_{p} f_{p} +
\sum_{c \in \mathcal{C}} C_{c} f_{c} +
\sum_{u \in \mathcal{U}} C_{u} f_{u}
\right)
\]
where $C_i$ is the cost per unit flow at element $i$, and $f_i$ is the corresponding gas flow.

\begin{align}
    \underline{f_{w}} \leq f_{w} \leq \overline{f_{w}} 
    &\quad \forall \ w \in \mathcal{W} 
    &&\parbox{3cm}{\centering Well capacity} \label{eq:well_limits} \\
    -\overline{f_{p}} \leq f_{p} \leq \overline{f_{p}} 
    &\quad \forall \ p \in \mathcal{P} 
    &&\parbox{3cm}{\centering Pipeline limits} \label{eq:pipe_limits} \\
    0 \leq f_{u} \leq \overline{f_{u}} 
    &\quad \forall \ u \in \mathcal{U} 
    &&\parbox{3cm}{\centering Demand satisfaction} \label{eq:dem_limit_gas} \\
    \sum_{m:(m,n)\in\mathcal{A}} f_{m} 
    &= \sum_{m':(n,m')\in\mathcal{A}} f_{m'} 
    &&\parbox{3cm}{\centering Nodal gas balance} \label{eq:gas_balance}
\end{align}
\end{frame}


\begin{frame}{Dataset}
\justifying
\footnotesize
Two different gas network configurations were used to evaluate the proposed CensNet-based model. 
The first is a small synthetic case for controlled experimentation, while the second corresponds 
to the real Colombian natural gas transportation system.

\begin{table}[H]
    \centering
    \scriptsize
    \begin{tabular}{lcccc}
        \toprule
        \textbf{Case} & \textbf{Nodes} & \textbf{Pipelines} & \textbf{Compressors} & \textbf{Users} \\
        \midrule
        Small Network & 8  & 6  & 2  & 2  \\
        Colombian Network & 63 & 48 & 14 & 27 \\
        \bottomrule
    \end{tabular}
    \caption{\footnotesize Datasets used in the study.}
\end{table}
\end{frame}




\begin{frame}{Experimental Setup}
\footnotesize 
Different network operation scenarios were generated by adding 5\%--25\% noise to user demand values 
and solving each scenario with the linear constrained optimization model using APOPT (via GEKKO). 
The outputs served as ground truth for CensNet model training.

\begin{itemize}
    \footnotesize 
    \item \textbf{Data split:} 60\% training, 20\% validation, 20\% testing.
    \item \textbf{Samples:} 2000 (8-node network), 2400 (63-node network).
    \item \textbf{Training:} 1500 epochs, Adam optimizer, Leaky ReLU activation ($\alpha = 0.2$).
    \item \textbf{Learning rate:} Initial $1\times 10^{-2}$, exponential decay (rate 0.9, steps 1000).
    \item \textbf{Hyperparameters:} 
        \begin{itemize}
            \footnotesize 
            \item $N_{\text{channels}}$: 16–64
            \item $N_{\text{layers}}$: 1–5 (CensNet convolutional)
            \item $N_{\text{dense}}$: 2–32 (post-dense layers)
        \end{itemize}
    \item \textbf{Losses tested:} 
        \begin{itemize}
            \footnotesize 
            \item Nodal loss only
            \item Nodal + Edge loss
        \end{itemize}
\end{itemize}
\end{frame}



\begin{frame}{Main Results: Prediction Accuracy}
\footnotesize 
\textbf{Networks:} 8-node (synthetic) and 63-node (Colombian gas system)  
\\
\textbf{Models:} CensNet (N) – nodal loss only, CensNet (N+E) – nodal + edge loss

\begin{itemize}
    \footnotesize 
    \item \textbf{Nodal flow predictions:} High $R^2$ in both settings
        \begin{itemize}
            \footnotesize 
            \item 8-node: $R^2$ = 0.988 (N), 0.988 (N+E)
            \item 63-node: $R^2$ = 0.996 (N), 0.996 (N+E)
        \end{itemize}
    \item \textbf{Edge flow predictions:} 
        \begin{itemize}
            \footnotesize 
            \item (N) performs poorly on edges: $R^2$ low
            \item (N+E) improves: $R^2$ up to 0.999 (8-node) and 0.996 (63-node)
        \end{itemize}
\end{itemize}

\textbf{Gas balance consistency (APOPT – CensNet differences):}
\begin{itemize}
    \footnotesize 
    \item \textbf{8-node:} Edge error reduced from 62.92 (N) $\rightarrow$ 39.24 (N+E)
    \item \textbf{63-node:} Edge error reduced from 62.47 (N) $\rightarrow$ -0.07 (N+E)
    \item Nodal differences $< 0.1$ units in all cases
\end{itemize}

\textbf{Prediction speed:}  
T-tests confirm \textbf{CensNet is significantly faster} than APOPT
\begin{itemize}
    \footnotesize 
    \item 8-node: $T=14.94$, $p=1.32\times10^{-34}$
    \item 63-node: $T=47.29$, $p=4.92\times10^{-110}$
\end{itemize}

\end{frame}


% \begin{frame}{Main Results: Gas Balance \& Speed}
% \footnotesize
% \textbf{Gas balance consistency (APOPT – CensNet differences):}
% \begin{itemize}
%     \item \textbf{8-node:} Edge error reduced from 62.92 (N) $\rightarrow$ 39.24 (N+E)
%     \item \textbf{63-node:} Edge error reduced from 62.47 (N) $\rightarrow$ -0.07 (N+E)
%     \item Nodal differences $< 0.1$ units in all cases
% \end{itemize}
%
% \textbf{Prediction speed:}  
% T-tests confirm \textbf{CensNet is significantly faster} than APOPT
% \begin{itemize}
%     \item 8-node: $T=14.94$, $p=1.32\times10^{-34}$
%     \item 63-node: $T=47.29$, $p=4.92\times10^{-110}$
% \end{itemize}
%
% \textbf{Summary:}  
% \begin{itemize}
%     \item Comparable accuracy to optimization model
%     \item Better edge prediction with (N+E)
%     \item Substantial speed advantage
% \end{itemize}
% \end{frame}


\begin{frame}{Interconnected system - Definition}
A power-gas interconnected system is a hybrid infrastructure that integrates natural gas and power networks, enhancing overall system efficiency~\cite{Duan_Liu_Yang_2022}. 
\begin{columns}
\begin{column}{0.5\textwidth}
   \begin{center}
     \includegraphics[width=1\textwidth]{figures/network_math_alternative.pdf}
     \end{center}
\end{column}
\begin{column}{0.5\textwidth}  %%<--- here
\begin{equation} \label{eq:obj_func_integrated}
\begin{split}
\min_{\mathcal{P}, \mathcal{F}} \quad  \sum_{g \in \mathcal{G}} C_{g}^t {P_{g}^t} + \sum_{d \in \mathcal{D}} C_{d}^t {P_{d}^t} +  \\ \sum_{w \in \mathcal{W}} C_{w}^t {f_{w}^t} +  \sum_{p \in \mathcal{P}} C_{p}^t {f_{p}^t}  + \\ \sum_{c \in \mathcal{C}} C_{c}^t {f_{c}^t} + \sum_{u \in \mathcal{U}} C_{u}^{t} {f_{u}^{t}} + \\ \quad \sum_{s \in \mathcal{S}} C_{s+}^{t} {f_{s+}^{t}}  + \sum_{s \in \mathcal{S}} C_{s-}^{t} {f_{s-}^{t}} + \\ \sum_{s \in \mathcal{S}} C_{s}^{t} {V_{s}^{t}}
\end{split}
\end{equation} 
\end{column}
\end{columns}
\end{frame}


% \begin{frame}{Objective function}
% \begin{columns}
% \begin{column}{0.5\textwidth}
%    \begin{center}
%      \includegraphics[width=1.1\textwidth]{figures/network_math_alternative.pdf}
%      \end{center}
% \end{column}
% \begin{column}{0.5\textwidth}  %%<--- here
% \begin{equation} \label{eq:obj_func_integrated}
% \begin{split}
% \min_{\mathcal{P}, \mathcal{F}} \quad  \sum_{g \in \mathcal{G}} C_{g}^t {P_{g}^t} + \sum_{d \in \mathcal{D}} C_{d}^t {P_{d}^t} +  \\ \sum_{w \in \mathcal{W}} C_{w}^t {f_{w}^t} +  \sum_{p \in \mathcal{P}} C_{p}^t {f_{p}^t}  + \\ \sum_{c \in \mathcal{C}} C_{c}^t {f_{c}^t} + \sum_{u \in \mathcal{U}} C_{u}^{t} {f_{u}^{t}} + \\ \quad \sum_{s \in \mathcal{S}} C_{s+}^{t} {f_{s+}^{t}}  + \sum_{s \in \mathcal{S}} C_{s-}^{t} {f_{s-}^{t}} + \\ \sum_{s \in \mathcal{S}} C_{s}^{t} {V_{s}^{t}}
% \end{split}
% \end{equation} 
% \end{column}
% \end{columns}
% \end{frame}
%
%

\begin{frame}{Power system constraints}

The constraints of the electrical system represent the technical limits of the different elements that compose it, as well as the physical laws that govern it. For certain applications, the DC model is sufficient~\cite{8468081}.

\begin{columns}
\begin{column}{0.24\textwidth}
% \begin{center}
\vspace{3pt}
    \includegraphics[width=1.4\textwidth]{figures/power_dummy_constraint.png}
% \end{center}
\end{column}
\begin{column}{0.8\textwidth}  %%<--- here


\begin{subequations}
\begin{alignat}{2}
    \underline{P_g^t} \leq P_{g}^t \leq \overline{P_g^t} &\quad &\forall \ g \in \mathcal{G}, \label{eq:gen_limits} \\
    -\overline{P_l^t} \leq P_{l}^t \leq \overline{P_l^t} &\quad &\forall \ l \in \mathcal{L}, \label{eq:line_limits} \\
    P_{l}^t = B_{nm}(\theta_n - \theta_{m}) &\quad &\forall \ l = (n, m) \in \mathcal{L}, \label{eq:dc_power_flow} \\
    0 \leq P_{d}^t \leq \overline{P_{d}^t} &\quad &\forall \ d \in \mathcal{D}, \label{eq:dem_limit_power} \\
    -\overline{\theta_{n}^t} \leq \theta_{m}^t \leq \overline{\theta_{n}^t} &\quad &\forall \ n \in \mathcal{N}_P, \label{eq:voltage_angle_limits} \\
    \sum_{\substack{l\in \mathcal{L}_{n+}\\g=n}}{P_{l}^t + P_{g}^t} = \sum_{\substack{l\in \mathcal{L}_{n-}\\d=n}} P_{l}^t + P_{d}^t &\quad &\forall \ n \in \mathcal{N}_P \label{eq:power_balance}
\end{alignat}
\end{subequations}
\end{column}
\end{columns}
\end{frame}


\begin{frame}{Interconnection constraints}
The second set of restrictions interconnects the natural gas and electric power systems through gas-fired power plants that generate electricity.  $f_{n}^t$ stands for the natural gas fuel consumption to generate a power $P_{n}^t$ at generator bus $n\in\mathcal{N}_I$, the heat-rate $\text{HR}_n$ defines the generator efficiency, and the set $\mathcal{N}_I=\mathcal{G}\cap\mathcal{U}$ holds all the units in the interconnected system belonging to both the power generator and gas demand sets.
    \begin{align}
    &f_{n}^t = P_{n}^t \cdot \text{HR}_n, \quad \forall \ n \in \mathcal{N}_I, \label{eq:gas_power_relation} 
\end{align}
\end{frame}


\begin{frame}{Gas system constraints}

This set of constraints ensures that wells, pipelines, nodal pressures, compressors, unsupplied demand and storage facilities operate within proper operating limits.~\cite{MPNG}.

\begin{columns}
\begin{column}{0.24\textwidth}
% \begin{center}
% \vspace{3pt}
    \includegraphics[width=1.5\textwidth]{figures/gas_dummy.png}
% \end{center}
\end{column}
\begin{column}{0.8\textwidth}
\scriptsize  % optional to avoid overfull boxes

\begin{subequations}
\begin{align}
    \underline{f_{w}^t} \leq f_{w}^t \leq \overline{f_{w}^t} &\quad \forall \ w \in \mathcal{W} \label{eq:well_limits} \\
    -\overline{f_{p}^t} \leq f_{p}^t \leq \overline{f_{p}^t} &\quad \forall \ p \in \mathcal{P} \label{eq:pipe_limits} \\
    \underline{\pi_{n}^t} \leq \pi_{n}^t \leq \overline{\pi_{n}^t} &\quad \forall \ n \in \mathcal{N}_f \label{eq:press_limit} \\
    \pi_{m}^t \leq \beta_{c}^t{\pi_{n}^t} &\quad \forall \ c=(n,m) \in \mathcal{C} \label{eq:comp_ratio} \\
    0 \leq f_{u}^{t} \leq \overline{f_{u}^{t}} &\quad \forall \ u \in \mathcal{U} \label{eq:dem_limit_gas} \\
    0 \leq f_{s+}^t \leq V_{0s} - \underline{V_s} &\quad \forall \ s \in \mathcal{S} \label{eq:sto_limit1} \\
    0 \leq f_{s-}^t \leq \overline{V_s} - V_{0s} &\quad \forall \ s \in \mathcal{S} \label{eq:sto_limit2} \\
    V_{s}^t = V_{s}^{t-1} + f_{s-}^{t-1} - f_{s+}^{t-1} &\quad \forall \ s \in \mathcal{S} \label{eq:sto_time}
\end{align}
\end{subequations}

\end{column}
\end{columns}
\end{frame}
%




\subsection{Weymouth equation}

\begin{frame}{Gas system constraints}
The gas balance constraints guarantee that the amount of gas entering a node equals the amount leaving it. On the other hand, the Weymouth equation encapsulates the complex physics of gas flow through pipelines between flow rates and pressures. 

\begin{subequations}
\begin{align}
    \sum_{m:(m,n)\in\mathcal{A}}{f_{m}^t} = \sum_{m':(n,m')\in\mathcal{A}}{f_{m'}^t} &\quad \forall \ n \in \mathcal{N}_f \label{eq:gas_balance} \\
    \text{sgn}(f_{p}^t)(f_{p}^t)^2 = K_{nm}((\pi_{n}^t)^2 - (\pi_{m}^t)^2) &\quad \forall \ p =(n,m) \in \mathcal{P} \label{eq:weymouth_cons}
\end{align}
\end{subequations}

Modeling this equation as a nonconvex and discontinuous equality constraint poses significant challenges for optimization algorithms. Specifically, the nonconvexity leads to multiple local optima, making it difficult to find the global optimum~\cite{JIANG2021106460}.
\end{frame}



\subsection{Proposed solution}
\begin{frame}{Proposed complementarity-based approach}
     Complementarity constraints can be used to represent non-uniform or discontinuous operators, such as absolute value, sign, and min/max \cite{mpcc}.
    \begin{gather}
            y = sgn(f_{T}^t)  \label{eq:sign}
    \end{gather}
    The sign equation can be represented by an optimization problem whose constraints avoid the use of binary variables.

\begin{subequations}
\begin{alignat}{4}
\label{eq:complementarity_relaxec3}
\mathcal{O}_W: \ &\min\limits_{y_p^t} -y_p^tf_{p}^t \\
& \text{s.t. } y_p^t(f_{p}^t)^2 = K_{nm}((\pi_{n}^t)^2-(\pi_{m}^t)^2)\\
& -1 \leq y_p^t \leq 1 \\
&f_{p}^t = f_{p+}^t - f_{p-}^t\\
& 0 \leq f_{p+}^t \perp (y_p^t+1) \geq 0 \\
& 0 \leq f_{p-}^t \perp (1-y_p^t) \geq 0
\end{alignat}
\end{subequations}

\end{frame}


\begin{frame}{Proposed complementarity-based approach}
   The program $\mathcal{O}_W$ misses the KKT conditions, because the conventional constraint qualifications for nonlinear programming are typically not satisfied in the case of MPCC~\cite{Bouza_Still_2007}. Hence, instead of working with the original problem, the relaxed problem $\mathcal{O}_\epsilon$ is considered:


\begin{subequations}
\begin{align}
\mathcal{O}_\epsilon: \quad &\min\limits_{y_p^t} \ -y_p^t f_p^t \label{eq:complementarity_relaxec1} \\
&\text{s.t.} \quad y_p^t (f_p^t)^2 = K_{nm} \left( (\pi_n^t)^2 - (\pi_m^t)^2 \right) \\
&f_p^t = f_{p+}^t - f_{p-}^t \\
&-1 \leq y_p^t \leq 1 \\
&f_{p+}^t (y_p^t + 1) \leq \epsilon \label{eq:Oe:complementarity1} \\
&f_{p-}^t (1 - y_p^t) \leq \epsilon \label{eq:Oe:complementarity2}
\end{align}
\end{subequations}

The regularized optimization model $\mathcal{O}_{\epsilon}$ offers several key properties that justify its use in tackling challenging MPCC problems~\cite{Ralph_Wright_2004}.
\end{frame}



\section{Experimental setup}
\begin{frame}{Databases}
Each of the mentioned databases was selected based on its unique characteristics and the significant contributions it could make to the study.

\begin{table}[]
\begin{tabular}{|c|c|c|c|c|}
\hline
                & \textbf{Topology}                                           & \textbf{\begin{tabular}[c]{@{}c@{}}Connection \\ points\end{tabular}} & \textbf{\begin{tabular}[c]{@{}c@{}}Closed\\ loops\end{tabular}} & \textbf{Problem}                                                                               \\ \hline
\textbf{Case 1} & \begin{tabular}[c]{@{}c@{}}9-bus\\ 8-system\end{tabular}    & 1                                                                          & 1                                                                      & \begin{tabular}[c]{@{}c@{}}Small system\\ with one loop\end{tabular}                           \\ \hline
\textbf{Case 2} & \begin{tabular}[c]{@{}c@{}}118-bus\\ 48-system\end{tabular} & 9                                                                          & 7                                                                      & \begin{tabular}[c]{@{}c@{}}Contains several\\ interconnected \\ loops\end{tabular}             \\ \hline
\textbf{Case 3} & \begin{tabular}[c]{@{}c@{}}96-bus\\ 63-system\end{tabular}  & 10                                                                         & 0                                                                      & \begin{tabular}[c]{@{}c@{}}Fully radial \\ but considers  \\ bidirectional flows.\end{tabular} \\ \hline
\end{tabular}
\caption{Databses used in the study}
\label{tab:databases}
\end{table}
\end{frame}

\begin{frame}{Experimental setup}
In order to establish a baseline for comparison, two alternative methodologies were employed: 
\begin{itemize}
    \item Taylor series approximation \cite{taylor_paper}.
    \item Second Order Cone Programming (SOC) \cite{soc_paper}.
\end{itemize}

The objective function value for each of the mentioned databases was computed by solving the optimization problem using: 
\begin{itemize}
    \item The IPOPT \cite{ipopt} solver.
    \item The GEKKO \cite{gekko} package. 
\end{itemize}

\end{frame}

\begin{frame}{Experimental setup}
    Since understanding and quantifying the inherent errors introduced by any constraint approximation approach supports its real-world pertinence, the considered validation trades off the reached cost function and constraint error values.

    \begin{equation}
    {WE}_p^t = |f_{p}^t - \left(K_{nm}|(\pi_{n}^t)^2-(\pi_{m}^t)^2|\right)^{1/2}| , \quad \forall \ p =(n,m) \in\mathcal{P}
\end{equation}
Hence, ${WE}_p^t$ metric explains the inherent sensitivity of tested approaches and validates the significance of their differences.
\end{frame}



\section{Results}
\begin{frame}{Results - Case 1}
To assess the performance of Weymouth approximation approaches on the 8/9 system, a Monte Carlo experiment estimates the cost function and Weymouth error distributions by solving  the optimization problem for one single day one hundred times with uniformly sampled natural gas demands. 

    \begin{figure}[!htb]
    \centering
    \setlength\figurewidth{.7\textwidth}        
    \setlength\figureheight{0.35\textwidth}
    % \input{images/blue_test_cost_SOC}
    \input{figures/all_test_cost}
    \caption{Cost function histogram attained for the Taylor, SOC, and MPCC Weymouth approximation approaches.}
    \label{fig:blue_test_cost}
\end{figure}
\end{frame}


\begin{frame}{Results - Case 1}
The boxplot examination reveals significantly lower approximation errors on the proposed complementarity constraints approach over key network arcs.

\begin{figure}[!htb]
    \centering
    \setlength\figurewidth{0.8\textwidth}        
    \setlength\figureheight{0.5\textwidth}
    \input{figures/blue_test_boxplot}
    \caption{Boxplot of Weymouth error distribution for each pipeline in the 8/9 system attained by contrasted approximation approaches.}
    \label{fig:blue_test_boxplot}
\end{figure}
\end{frame}


\begin{frame}{Results - Case 2}
It is worth noting that both baselines yielded the same objective function values. The consistently positive relative difference indicates that the complementarity constraints formulation always yields larger cost values than Taylor and SOC for the 118/48 system.

\begin{figure}[!htb]
    \centering
    \setlength\figurewidth{0.75\textwidth}        
    \setlength\figureheight{0.35\textwidth}
    \input{figures/green_test_hist}
    \caption{Histogram depicting the relative frequencies of cost differences obtained between MPCC and the other approaches in the 48-node 118-bus system.}
    \label{fig:green_test_cost}
\end{figure}
\end{frame}


\begin{frame}{Results - Case 2}
Contrarily to cost function analysis, Weymouth approximation results reveal a significant error reduction of about seven orders of magnitude (from $10^1$ to $10^{-6}$) under the proposed complementarity constraints.
\begin{figure}[!htb]
\setlength\figurewidth{0.37\textwidth}        
\setlength\figureheight{0.4\textwidth}
\subfloat[Taylor]{\input{figures/green_test_error_Taylor}}
\subfloat[SOC]{\input{figures/green_test_error_SOC}}
\subfloat[MPCC]{\input{figures/green_test_error_MPCC}}
\caption{Weymouth approximation errors for each pipeline $p$ reached by Taylor (left), SOC (center), and MPCC (right) approaches in the 118/48 system.}\label{fig:green_test_error}
\end{figure}
\end{frame}


\begin{frame}{Results - Case 3}
Instead of estimating the distributions of the objective function and Weymouth error as in cases 9/8 and 118/48, the 96/63 case validates the Weymouth approximations in an operation case of ten consecutive days ($\left | \mathcal{T} \right | = 10 $) with randomly changing gas extraction costs.
    \begin{figure}[!htb]
    \centering
    \setlength\figurewidth{0.8\textwidth}        
    \setlength\figureheight{0.4\textwidth}
    \input{figures/red_test_costs}
    \caption{Daily operating cost obtained with each of the approaches in the 63-node 96-bus system.}
    \label{fig:red_test_cost}
\end{figure}
\end{frame}


\begin{frame}{Results - Case 3}
    Regarding the Weymouth approximation analysis, the figure presents the error distribution and its relationship with the gas flow and the scheduled day for Taylor, SOC, and MPCC

    \begin{figure}[!htb]
\setlength\figurewidth{0.37\textwidth}        
\setlength\figureheight{0.4\textwidth}
\subfloat[Relative Frequency]{\label{fig:case3error}\input{figures/pruebatikz}}
\subfloat[Pipeline flow ($f_m^t$)]{\label{fig:case3flow}\input{figures/redtest_scatter_flow1.tex}}
\subfloat[Operation day ($t$)]{\label{fig:case3day}\input{figures/err_day}}
\caption{Errors in the Weymouth equation expressed in three different formats- general error, error per flow, and error per day.}\label{fig:red_test_error}
\end{figure}
\end{frame}



\begin{frame}{Physics-Guided Neural Networks}
\footnotesize
\textbf{Motivation:}
\begin{itemize}
    \item Traditional neural networks: fit data, ignore physics → risk of unrealistic predictions.
    \item In gas networks, physical constraints (mass balance, pressure-flow laws) are critical.
\end{itemize}

\textbf{Physics-Informed Neural Networks (PINNs):}
\begin{itemize}
    \item Incorporate governing equations directly in the loss function.
    \item Penalize deviations from:
    \begin{itemize}
        \item \textbf{Gas balance constraint} – nodal mass conservation.
        \item \textbf{Weymouth equation} – relation between flow and pressure differences in pipelines.
    \end{itemize}
    \item Acts as a \emph{regularizer} for better generalization under uncertainty.
\end{itemize}

% \textbf{Goal:}
% \begin{itemize}
%     \item Improve prediction accuracy and physical consistency.
%     \item Enable robust, uncertainty-aware gas dispatch optimization.
% \end{itemize}
\end{frame}



\begin{frame}{Methodology: Physics-Guided CensNet}
\footnotesize
\textbf{Overall loss function:}
\[
\mathcal{J}(\Theta) =
\mathcal{J}_{\text{data}} +
\mathcal{J}_{\text{balance}} +
\mathcal{J}_{\text{weymouth}}
\]

\textbf{Gas balance loss:}
\[
\mathcal{J}_{\text{balance}} =
\mathbf{T} \cdot \hat{\mathbf{f}}_e - \mathbf{d} + \hat{\mathbf{f}}_n
\]
\begin{itemize}
    \item Enforces nodal inflow = outflow + demand.
\end{itemize}

\textbf{Weymouth loss:}
\[
\mathcal{J}_{\text{weymouth}} =
\mathbf{M}_{\mathcal{P}}
\left( \hat{\mathbf{f}}_e^{\circ 2} -
\mathbf{K} \circ \left(\mathbf{T} \cdot \hat{\boldsymbol{\pi}}^{\circ 2} \right) \right)
\]
\begin{itemize}
    \item Relates squared flows to squared pressure differences.
    \item Applies only to pipelines (not compressors).
\end{itemize}
\end{frame}

\begin{frame}{Methodology: Physics-Guided CensNet}
\textbf{Implementation:}
\begin{itemize}
    \item Built on CensNet architecture from deterministic setup.
    \item Training data from nonlinear gas network optimization (MPCC).
    \item Noise (5\%–25\%) injected to emulate operating uncertainty.
\end{itemize}

\centering
    \resizebox{0.9\linewidth}{!}{\input{figures/model_description_PINN}}
\end{frame}



% % --- Slide 1: Table of Results ---

\begin{frame}{Case Study I: 8-Node Network -- Performance Comparison}
\scriptsize
\centering
\begin{table}
\captionsetup{font=scriptsize}  % Cambia el tamaño del caption a \tiny
\centering
\begin{tabular}{lcccc}
\toprule
\textbf{Method} & \textbf{Node Error} & \textbf{Edge Error} & \textbf{Balance Error} & \textbf{Time (s)} \\
\midrule
CensNet (N) & $0.00 \pm 17.99$ & $22.76 \pm 15.43$ & $-0.01 \pm 17.45$ & $0.86 \pm 0.50$ \\
CensNet (N+E) & $-0.11 \pm 18.27$ & $0.22 \pm 21.65$ & $-0.12 \pm 1.70$ & $0.85 \pm 0.50$ \\
CensNet (N+E+B) & $-0.02 \pm 18.00$ & $-0.02 \pm 21.30$ & $-0.03 \pm 0.90$ & $0.85 \pm 0.50$ \\
CensNet (N+E+W) & $-0.07 \pm 17.56$ & $2.60 \pm 20.03$ & $-0.07 \pm 2.21$ & $0.86 \pm 0.50$ \\
CensNet (N+E+B+W) & $0.05 \pm 17.91$ & $0.25 \pm 21.14$ & $0.05 \pm 1.69$ & $0.85 \pm 0.50$ \\
\bottomrule
\end{tabular}
\caption{Performance of CensNet-based models vs. IPOPT benchmark.}
\end{table}

\begin{itemize}
    \item Using only node loss leads to accurate nodal flows but large errors in edge predictions.
    \item Adding edge loss (\textbf{N+E}) reduces edge error from $22.76$ to $0.22$ and improves global balance.
    \item Including balance loss (\textbf{N+E+B}) further minimizes balance error, achieving best overall consistency.
    \item Weymouth loss (\textbf{N+E+W}) introduces slight trade-offs, slightly increasing edge/balance errors but retaining nodal accuracy.
    \item All CensNet variants are over an order of magnitude faster than IPOPT, with \textbf{N+E+B} offering the best accuracy-speed compromise.
\end{itemize}

\end{frame}


% % % --- Slide 2: Main Observations ---
% \begin{frame}{Case Study I: Key Observations}
% \begin{itemize}
%     \item Using only node loss leads to accurate nodal flows but large errors in edge predictions.
%     \item Adding edge loss (\textbf{N+E}) reduces edge error from $22.76$ to $0.22$ and improves global balance.
%     \item Including balance loss (\textbf{N+E+B}) further minimizes balance error, achieving best overall consistency.
%     \item Weymouth loss (\textbf{N+E+W}) introduces slight trade-offs, slightly increasing edge/balance errors but retaining nodal accuracy.
%     \item All CensNet variants are over an order of magnitude faster than IPOPT, with \textbf{N+E+B} offering the best accuracy-speed compromise.
% \end{itemize}
% \end{frame}


\begin{frame}{Stochastic Analysis: Methodology}
    \begin{itemize}
        \item Kernel Density Estimate (KDE) fitted to training inputs.
        \item Synthetic samples generated and propagated through CensNet.
        \item Log-likelihoods compared for $y_{\text{sample}}$ and $\bar{y}_{\text{train}}$.
        \item Kolmogorov–Smirnov (K–S) test used for distributional similarity.
    \end{itemize}
\end{frame}

\begin{frame}{Model Robustness under Uncertainty}
    \begin{itemize}
        \item Log-likelihoods: $y_{\text{sample}} = -6.696 \times 10^6$, 
              $\bar{y}_{\text{train}} = -6.657 \times 10^6$.
        \item K–S test: $p > 0.44$ across all alternatives.
        \item $\Rightarrow$ Synthetic outputs statistically consistent with training outputs.
    \end{itemize}
\end{frame}

\begin{frame}{Negative Flows in Pipeline $p_3$}
    \begin{itemize}
        \item Flow in $p_3$ consistently negative across scenarios and KDE samples.
        \item Caused by orientation assumption $\rightarrow$ optimizer adjusts direction.
        \item Operability unaffected, but $p_3$ supports cost minimization.
    \end{itemize}
    \begin{figure}
        \includegraphics[width=0.65\textwidth]{figures/outputs_outputs_2.png}
        \caption*{Joint PDFs showing negative $p_3$ flows.}
    \end{figure}
\end{frame}

\begin{frame}{Pressure Concentration in Mid-Range}
    \begin{itemize}
        \item Nodal pressures cluster at 30--40\% of normalized limits.
        \item Avoids extremes, ensuring reliable operation.
        \item Implies optimizer favors efficiency + stability.
    \end{itemize}
    \begin{figure}
        \includegraphics[width=0.6\textwidth]{figures/outputs_outputs_3.png}
        \caption*{Pressures concentrate in mid-range (30--40\%).}
    \end{figure}
\end{frame}


\begin{frame}{Stable Utilization of Pipeline $p_4$}
    \begin{itemize}
        \item Despite wide dispersion in inputs, $p_4$ flow remains 20--40\%.
        \item Reflects robustness: optimizer stabilizes this delivery path.
        \item Behavior consistently learned and reproduced in KDE samples.
    \end{itemize}
    \begin{figure}
        \includegraphics[width=0.7\textwidth]{figures/inputs_outputs_1.png}
        \caption*{Optimization model: input variability vs. stable $p_4$ flow.}
    \end{figure}
    % \begin{figure}
    %     \includegraphics[width=0.7\textwidth]{figures/Chapter_NonLinealCensnet/inputs_outputs_1_KDE.png}
    %     \caption*{KDE samples confirm concentration of $p_4$ flow at 20--40\%.}
    % \end{figure}
\end{frame}

\begin{frame}{Linear Input--Output Relations}
    \begin{itemize}
        \item Positive correlation: demand bounds ($N_6$, $N_7$) vs. $p_4$--$p_7$ flows.
        \item Negative correlation: $N_7$ demand bound vs. $p_3$ flow.
        \item Shows network internalized optimizer’s allocation strategies.
    \end{itemize}
    \begin{figure}
        \includegraphics[width=0.7\textwidth]{figures/inputs_outputs_2.png}
        \caption*{Optimization model: linear input–output patterns.}
    \end{figure}
    % \begin{figure}
    %     \includegraphics[width=0.7\textwidth]{figures/Chapter_NonLinealCensnet/inputs_outputs_2_KDE.png}
    %     \caption*{KDE samples replicate both positive and negative correlations.}
    % \end{figure}
\end{frame}


\begin{frame}{Key Conclusions}
    \begin{itemize}
        \item \textbf{GNN-based prediction:} CensNet achieved accurate and scalable predictions for natural gas networks, with significant reductions in computation time compared to traditional optimization.
        \item \textbf{Optimization with MPCC:} Proposed formulation rigorously approximated Weymouth constraints, improving accuracy of pressure–flow representation and showing robustness in real-world scheduling tasks.
        \item \textbf{Stochastic modeling:} Physics-guided neural networks preserved structural dependencies and generalized reliably under uncertainty, validated through KDE sampling and K–S testing.
        \item \textbf{Overall:} Integrating physical constraints with GNNs yields efficient, accurate, and robust surrogates for optimization in natural gas systems.
    \end{itemize}
\end{frame}

\begin{frame}{Future Work}
    \begin{itemize}
        \item Extend stochastic framework toward \textbf{full stochastic optimization} for gas–power coordination.
        \item Explore \textbf{physics-informed neural operators} to improve learning of nonlinear constraints (e.g., Weymouth).
        \item Incorporate \textbf{real operational data} from SCADA systems to validate scalability in live environments.
        \item Investigate \textbf{transfer learning across networks}, enabling models trained on one topology to adapt to others with minimal retraining.
        \item Apply developed methods to \textbf{decision-support tools} for dispatchers in interconnected energy systems.
    \end{itemize}
\end{frame}

\section{Bibliography}
\begin{frame}[allowframebreaks]
        \frametitle{References}
        \bibliographystyle{apalike}
        \bibliography{biblio}
\end{frame}



\end{document}
